{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'marketing/css/lead_create.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/fonts.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h2>{{ title }}</h2>
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        <form method="post" class="lead-form">
            {% csrf_token %}
            <div class="form-group">
{#                <label for="{{ form.first_name.id_for_label }}">نام</label>#}
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="error-message">{{ form.first_name.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
{#                <label for="{{ form.last_name.id_for_label }}">نام خانوادگی</label>#}
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="error-message">{{ form.last_name.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
{#                <label for="{{ form.phone_number.id_for_label }}">تلفن همراه</label>#}
                {{ form.phone_number }}
                {% if form.phone_number.errors %}<div class="error-message">{{ form.phone_number.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
{#                <label for="{{ form.phone.id_for_label }}">شماره ثابت</label>#}
                {{ form.phone }}
                {% if form.phone.errors %}<div class="error-message">{{ form.phone.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
{#                <label for="{{ form.mellicode.id_for_label }}">کد ملی</label>#}
                {{ form.mellicode }}
                {% if form.mellicode.errors %}<div class="error-message">{{ form.mellicode.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
{#                <label for="{{ form.city.id_for_label }}">شهر</label>#}
                {{ form.city }}
                {% if form.city.errors %}<div class="error-message">{{ form.city.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="{{ form.source.id_for_label }}">منبع</label>
                {{ form.source }}
                {% if form.source.errors %}<div class="error-message">{{ form.source.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                <div class="label-container">
                    <label for="{{ form.requested_products.id_for_label }}">کالاهای درخواستی</label>
                    <button type="button" class="create-product-btn" onclick="openProductModal()"><i class="fas fa-plus"></i></button>
                </div>
                {{ form.requested_products }}
                {% if form.requested_products.errors %}<div class="error-message">{{ form.requested_products.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                <div class="label-container">
                    <label for="{{ form.tags.id_for_label }}">تگ‌ها</label>
                    <button type="button" class="create-product-btn" onclick="openTagModal()"><i class="fas fa-plus"></i></button>
                </div>
                {{ form.tags }}
                {% if form.tags.errors %}<div class="error-message">{{ form.tags.errors }}</div>{% endif %}
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-submit">ذخیره</button>
                <a href="{% url 'marketing:lead_list' %}" class="btn-cancel">انصراف</a>
            </div>
        </form>
    </div>
</div>
<!-- Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>ایجاد کالای جدید</h3>
        <form id="newProductForm" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="type">نوع کالا</label>
                <select name="type" id="type" required>
                    <option value="">انتخاب کنید</option>
                    <option value="mobile">موبایل</option>
                    <option value="laptop">لپ‌تاپ</option>
                    <option value="watch">طلا</option>
                    <option value="other">سایر</option>
                </select>
            </div>
            <div class="form-group">
                <label for="brand">برند</label>
                <input type="text" name="brand" id="brand" required>
            </div>
            <div class="form-group">
                <label for="model_name">مدل کالا</label>
                <input type="text" name="model_name" id="model_name" required>
            </div>
            <button type="submit">ذخیره</button>
        </form>
    </div>
</div>
<!-- Tag Modal -->
<div id="tagModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>ایجاد تگ جدید</h3>
        <form id="newTagForm" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="tag_name">نام تگ</label>
                <input type="text" name="name" id="tag_name" required>
            </div>
            <button type="submit">ذخیره</button>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    // Modal functionality (unchanged)
    var productModal = document.getElementById("productModal");
    var tagModal = document.getElementById("tagModal");
    var closeButtons = document.getElementsByClassName("close");
    function openProductModal() { productModal.style.display = "block"; }
    function openTagModal() { tagModal.style.display = "block"; }
    for (var i = 0; i < closeButtons.length; i++) {
        closeButtons[i].onclick = function() {
            productModal.style.display = "none";
            tagModal.style.display = "none";
        }
    }
    window.onclick = function(event) {
        if (event.target == productModal) { productModal.style.display = "none"; }
        if (event.target == tagModal) { tagModal.style.display = "none"; }
    }
    // AJAX for product and tag creation (unchanged)
    $('#newProductForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: '{% url "marketing:product_create" %}',
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    var newOption = new Option(response.product.text, response.product.id, true, true);
                    $('#id_requested_products').append(newOption);
                    productModal.style.display = "none";
                    $('#newProductForm')[0].reset();
                } else {
                    alert('خطا در ایجاد کالا: ' + response.error);
                }
            },
            error: function() { alert('خطا در ارتباط با سرور'); }
        });
    });
    $('#newTagForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: '{% url "marketing:tag_create" %}',
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    var newOption = new Option(response.tag.text, response.tag.id, true, true);
                    $('#id_tags').append(newOption);
                    tagModal.style.display = "none";
                    $('#newTagForm')[0].reset();
                } else {
                    alert('خطا در ایجاد تگ: ' + response.error);
                }
            },
            error: function() { alert('خطا در ارتباط با سرور'); }
        });
    });
</script>
{% endblock %}